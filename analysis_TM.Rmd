---
title: "Data_Analisis_Scopus_WoS"
author: "Sebastian Robledo"
date: "1/28/2022"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Creating the environment

```{r, echo=FALSE}
library(tidyverse)
library(tidygraph)
library(igraph)
library(bibliometrix)
library(tosr)
library(here)
library(lubridate)
library(sjrdata)
```

# Getting data

```{r}
wos <- bibliometrix::convert2df(here("data", 
                                     "savedrecs_TM.txt"), 
                                "wos", 
                                format = "plaintext")

scopus <- bibliometrix::convert2df(here("data",
                                        "scopus_TM.bib"), 
                                   dbsource = "scopus", 
                                   format = "bibtex")

wos_scopus_tos <- tosr_load("data/savedrecs_TM.txt", "data/scopus_TM.bib")

```

# Data tidying

We will merge Scopus and WoS

```{r}
wos_scopus_unique <- 
  scopus |> 
  select(SR) |> 
  bind_rows(wos |> 
              select(SR)) |> 
  unique() # There are 2042 unique registers
```

We add scopus and wos dataset

```{r}
wos_scopus_unique_scopus <- 
  wos_scopus_unique |> 
  left_join(scopus |> 
              mutate(database = "scopus"), 
            by = "SR") 

wos_scopus_unique_wos <- 
  wos_scopus_unique_scopus |>
  filter(is.na(database)) |> 
  select(SR) |> 
  left_join(wos |> 
              mutate(database = "wos"), 
            by = "SR")
```

Unifying tags in scopus and wos

```{r}
wos_titles <- tibble(title = names(wos))
scopus_titles <- tibble(title = names(scopus))

unique_scopus_wos_titles <- inner_join(scopus_titles, wos_titles)
```

Selecting only unique tags in both datasets

```{r}
scopus_unique_titles <- 
  wos_scopus_unique_scopus |> 
  filter(!is.na(database)) |> 
  select(unique_scopus_wos_titles |> 
           pull())

wos_unique_titles <- 
  wos_scopus_unique_wos |> 
  select(unique_scopus_wos_titles |> 
           pull())
```

Merging both datasets scopus and wos

```{r}
scopus_wos_final <- 
  scopus_unique_titles |> 
  bind_rows(wos_unique_titles) # 2042 registers!!!!!
```

# Data analysis

```{r}
wos_anual_production <- 
  wos |> 
  select(PY) |> 
  count(PY, sort = TRUE) |> 
  na.omit() |> 
  filter(PY >= 2000,
         PY < year(today())) |> 
  mutate(ref_type = "wos") 

scopus_anual_production  <- 
  scopus |> 
  select(PY) |> 
  count(PY, sort = TRUE) |> 
  na.omit() |> 
  filter(PY >= 2000,
         PY < year(today())) |>
  mutate(ref_type = "scopus") |> 
  bind_rows(tibble(PY = 2007, n = 0, ref_type = "scopus"))

total_anual_production <- 
  wos_scopus_tos$df |> 
  select(PY) |> 
  count(PY, sort = TRUE) |> 
  na.omit() |> 
  filter(PY >= 2000,
         PY < year(today())) |>
  mutate(ref_type = "total") |> 
  bind_rows(tibble(PY = 2007, n = 0, ref_type = "total"))

wos_scopus_total_annual_production <- 
  wos_anual_production |> 
  bind_rows(scopus_anual_production,
            total_anual_production) 

figure_1_data <- 
  wos_scopus_total_annual_production |> 
  mutate(PY = replace_na(PY, replace = 0)) |> 
  pivot_wider(names_from = ref_type, 
              values_from = n) |> 
  arrange(desc(PY))

wos_scopus_total_annual_production |> 
  ggplot(aes(x = PY, y = n, color = ref_type)) +
  geom_line() +
  labs(title = "Annual Scientific Production", 
       x = "years",
       y = "papers") +
  theme(plot.title = element_text(hjust = 0.5)) 
```

I would like to create a bar graph of WoS and Scopus data

We need to identify the times cited variable for each database and later sum them all.

Time Cited from web of science

```{r}
TC_wos <- 
  wos |> 
  select(PY, TC) |> 
  group_by(PY) |> 
  summarise(TC_sum = sum(TC)) |> 
  arrange(desc(PY)) |> 
  na.omit() 
```

Time Cited from WoS

```{r}
TC_scopus <- 
  scopus |> 
  select(PY, TC) |> 
  group_by(PY) |> 
  summarise(TC_sum = sum(TC)) |> 
  arrange(desc(PY)) |> 
  na.omit() 
```

# Figure 1

## Figure 1a

```{r}
figure_1a <- 
  wos_scopus_total_annual_production |> 
  filter(ref_type != "total") |> 
  ggplot(aes(x = factor(PY), 
             y = n, 
             fill = ref_type)) +
  geom_bar(stat = "identity", 
           position = "dodge") +
  geom_text(aes(label = n),
            vjust = -0.3,
            position = position_dodge(0.9),
            size = 3,
            family = "Times") +
  scale_fill_manual(values = c("springgreen3",
                               "orange3")) +
  theme(text = element_text(family = "Times",
                            face = "bold",
                            size =12),
        panel.background = element_rect(fill = "white"),
        legend.position = "bottom",
        legend.title = element_text(size = 0),
        axis.text.x = element_text(face = "bold", 
                                   angle = 45, 
                                   vjust = 0.5),
        axis.line = element_line(color = "black", 
                                 size = 0.2)) +
  labs(y = "Number of publications", 
       x = "Year") +
  scale_y_continuous(breaks = seq(0,300, 
                                  by = 50)) 
figure_1a

```

## Figure 1b

```{r}

figure_1b <- 
  figure_1_data |> 
  ggplot(aes(x = PY, y = total)) +
  geom_line(stat = "identity", color = "red") +
  geom_point(stat = "identity", color = "red") +
  scale_x_continuous(breaks = seq(2004, 2021, by = 1)) +
  geom_text(aes(label = total),
            vjust = -0.3,
            position = position_dodge(0.9),
            size = 3,
            family = "Times", 
            color = "red") +
  scale_fill_manual(values = c("springgreen3",
                               "orange3")) +
  theme(text = element_text(family = "Times",
                            face = "bold",
                            size =12),
        panel.background = element_rect(fill = "white"),
        legend.position = "bottom",
        legend.title = element_text(size = 0),
        axis.text.x = element_text(face = "bold", 
                                   angle = 45, 
                                   vjust = 0.5),
        axis.line = element_line(color = "black", 
                                 size = 0.2)) +
  labs(y = "Number of total publications", 
       x = "Year") +
  scale_y_continuous(breaks = seq(0,300, 
                                  by = 50)) 

figure_1b

```

## Figure 1c

```{r}
TC_all <- 
  TC_scopus |> 
  left_join(TC_wos, 
            by = "PY", 
            suffix = c("_wos", 
                       "_scopus")) |> 
  replace_na(replace = list(TC_sum_scopus = 0)) |> 
  mutate(TC_sum_all = TC_sum_wos + TC_sum_scopus,
         TC_total = sum(TC_sum_all),
         TC_percentage = round(TC_sum_all/TC_total, digits = 2)) |> 
  select(PY, TC_sum_all, TC_percentage) |> 
  filter(PY != 2022)

figure_1c <- 
  TC_all |> 
  ggplot(aes(x = PY , y = TC_sum_all)) +
  geom_line(stat = "identity", color = "purple") +
  geom_point(color = "purple") +
  scale_x_continuous(breaks = seq(2004, 2021, by = 1)) +
  geom_text(aes(label = TC_sum_all),
            vjust = -0.3,
            position = position_dodge(0.9),
            size = 3,
            family = "Times", 
            color = "purple") +
  scale_fill_manual(values = c("springgreen3",
                               "orange3")) +
  theme(text = element_text(family = "Times",
                            face = "bold",
                            size =12),
        panel.background = element_rect(fill = "white"),
        legend.position = "bottom",
        legend.title = element_text(size = 0),
        axis.text.x = element_text(face = "bold", 
                                   angle = 45, 
                                   vjust = 0.5),
        axis.line = element_line(color = "black", 
                                 size = 0.2)) +
  labs(y = "Number of citations", 
       x = "Year") +
  scale_y_continuous(breaks = seq(0,3500, 
                                  by = 500)) 

figure_1c
```

## Figure 1 - Final

Final Figure 1 with inkscape

![](figures/Figure_1_1.svg)

# Descriptive analysis

### Total publications

Total papers in the whole time

```{r}
total_publications <- 
  wos_scopus_total_annual_production |> 
  filter(ref_type %in% c("wos", "scopus")) |> 
  select(n) |> 
  summarize(total = sum(n)) |> 
  pull()

total_publications
```

### Total Citations

```{r}
TC_all_pull <- 
  TC_all |>
  summarize(ig_total_citaitons = sum(TC_sum_all)) |> 
  pull()

TC_all_pull
```

### Initial Growth Stage

Total papers in the initial growth stage

```{r}
ig_stage_publications <- 
  wos_scopus_total_annual_production |> 
  filter(PY >= 2004, 
         PY <= 2013, 
         ref_type %in% c("wos", "scopus")) |> 
  select(n) |> 
  summarize(total = sum(n))

ig_stage_publications |> pull()
```

Therefore, the proportion of papers in the initial stage compare with the sum of all stages is **10.54%** (227/2154\*100)

Total papers for WoS in the initial growth stage

```{r}
ig_stage_publications_wos <- 
  wos_scopus_total_annual_production |> 
  filter(PY >= 2004, 
         PY <= 2013, 
         ref_type %in% c("wos", "scopus")) |> 
  filter(ref_type == "wos") |>
  select(n) |> 
  summarize(total = sum(n))

ig_stage_publications_wos |> pull()
```

Total papers for Scopus in the initial growth stage

```{r}
ig_stage_publications_scopus <- 
  wos_scopus_total_annual_production |> 
  filter(PY >= 2004, 
         PY <= 2013, 
         ref_type %in% c("wos", "scopus")) |> 
  filter(ref_type == "scopus") |>
  select(n) |> 
  summarize(total = sum(n))

ig_stage_publications_scopus |> pull()
```

Total citations in initial growth stage

```{r}
TC_ig <- 
  TC_all |> 
  filter(PY >= 2004, 
         PY <= 2013) |> 
  summarize(ig_total_citaitons = sum(TC_sum_all)) |> 
  pull()

TC_ig
```

```{r}

TC_ig/TC_all_pull*100
```

What is the most cited paper during IG stage?

```{r}
wos_scopus_tos$df |> 
  select(TI, TC, PY) |> 
  filter(PY >=2004,
         PY <= 2013) |> 
  arrange(desc(TC)) |> View()

```

### Rapid Development Stage

Total papers in the rd stage

```{r}
rd_stage_publications <- 
  wos_scopus_total_annual_production |> 
  filter(PY >= 2014, 
         PY <= 2019, 
         ref_type %in% c("wos", "scopus")) |> 
  select(n) |> 
  summarize(total = sum(n)) |> 
  pull()

rd_stage_publications

```

Percentage of the total publications

```{r}
rd_stage_publications / total_publications *100
```

Total citations in the rd stage

```{r}
TC_rd <- 
  TC_all |> 
  filter(PY >= 2014, 
         PY <= 2019) |> 
  summarize(ig_total_citaitons = sum(TC_sum_all)) |> 
  pull()

TC_rd
```

Percentage of the total citations

```{r}
TC_rd / TC_all_pull *100
```

Calculating the average growth percentage of publications during rd stage

```{r}
rd_publications_growth_rate <- 
  wos_scopus_tos$df %>%
  filter(PY >= 2014,
         PY <= 2019) |> 
  select(PY) |> 
  count(PY) |> 
  # first sort by year
  arrange(PY) %>%
  mutate(diff_growth = n - lag(n),
         rate_percentage = (diff_growth/n)*100,
         rate_percentage = round(rate_percentage, 
                                 digits = 2) )

mean(rd_publications_growth_rate |> 
       select(rate_percentage) |> 
       pull(), 
     na.rm = TRUE)
```

Finding the most cited document during this stage

```{r}
wos_scopus_tos$df |> 
  filter(PY == 2016) |>
  select(TI, PY, TC) |> 
  arrange(desc(TC)) |> 
  slice(1) |> 
  select(TI) |> 
  pull()
```

Which is the most productive journal in rd stage

```{r}
wos_scopus_tos$df |> 
  filter(PY >= 2014,
         PY <= 2019) |>
  select(SO, TC) |>
  filter(TC > 0) |>
  group_by(SO) |> 
  summarise(sum_citations = sum(TC),
            count = n()) |> View()
```

### Stability Stage

```{r}
stability_stage_publications <- 
  wos_scopus_total_annual_production |> 
  filter(PY >= 2020, 
         PY <= 2021, 
         ref_type %in% c("wos", "scopus")) |> 
  select(n) |> 
  summarize(total = sum(n)) |> 
  pull()

stability_stage_publications
  
```

Percentage

```{r}
stability_stage_publications / total_publications * 100
```

Growth rate

```{r}
stability_publications_growth_rate <- 
  wos_scopus_tos$df %>%
  filter(PY >= 2020,
         PY <= 2021) |> 
  select(PY) |> 
  count(PY) |> 
  # first sort by year
  arrange(PY) %>%
  mutate(diff_growth = n - lag(n),
         rate_percentage = (diff_growth/n)*100,
         rate_percentage = round(rate_percentage, 
                                 digits = 2) )

mean(stability_publications_growth_rate |> 
       select(rate_percentage) |> 
       pull(), 
     na.rm = TRUE)
```

# Country production analysis

## Table 2

```{r}
wos_scopus_countries <- 
  wos_scopus_tos$df |> 
  select(SR, AU_CO, TC) |> 
  separate_rows(AU_CO, sep = ";") |> 
  unique() |> 
  drop_na()

wos_scopus_countries_journals <- 
  wos_scopus_countries |> 
  left_join(wos_scopus_tos$df |> 
              select(SR, SO, PY), 
            by = "SR")

scimago_2020 <- 
  read_csv2("data/scimago2020.csv") |> 
  select(SO = Title,
         quartile = "SJR Best Quartile") |> 
  mutate(PY = 2020)

scimago_2021 <- 
  read_csv2("data/scimago2020.csv") |> 
  select(SO = Title,
         quartile = "SJR Best Quartile") |> 
  mutate(PY = 2021)

scimago <- 
  sjr_journals |> 
  select(PY = year, 
         SO = title,
         quartile = sjr_best_quartile) |> 
  mutate(SO = str_to_upper(SO),
         PY = as.numeric(PY)) |> 
  bind_rows(scimago_2020_2021)

scimago_2020_2021 <- 
  scimago_2020 |> 
  bind_rows(scimago_2021) |> 
  select(PY, SO, quartile)

wos_scopus_countries_journals_scimago <- 
  wos_scopus_countries_journals |> 
  left_join(scimago, by = c("PY", "SO")) |>  
  drop_na() |> 
  select(AU_CO, TC, quartile) |> 
  filter(quartile != "-")


```

### Table 2a - production

Production per country

```{r}
table_2a <- 
  wos_scopus_countries |> 
  count(AU_CO, sort = TRUE)

table_2a
```

### Table 2b - citations

Citations recieved per country

```{r}
table_2b <- 
  wos_scopus_countries_journals_scimago |> 
  select(AU_CO, TC) |> 
  group_by(AU_CO) |> 
  summarise(citation = sum(TC)) |> 
  arrange(desc(citation))

table_2b
```

### Table 2c - Quartiles

```{r}
table_2c <- 
  wos_scopus_countries_journals_scimago |> 
  select(AU_CO, quartile) |> 
  group_by(AU_CO) |> 
  count(quartile, sort = TRUE) |> 
  pivot_wider(names_from = quartile, 
              values_from = n) |> 
  select(AU_CO, Q1, Q2, Q3, Q4) |> 
  mutate(Q1 = replace_na(Q1, 0),
         Q2 = replace_na(Q2, 0),
         Q3 = replace_na(Q3, 0),
         Q4 = replace_na(Q4, 0))


table_2c
```

### Table 2 - Final

Merging all tables 2

```{r}
table_2 <- 
  table_2a |> 
  left_join(table_2b, by = "AU_CO") |> 
  left_join(table_2c, by = "AU_CO") |> 
  slice(1:10)

table_2
```
